<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Les Tehilim de Maman</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Police Noto Serif & Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans', sans-serif; }
        .font-serif { font-family: 'Noto Serif', serif; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; }
        .tab-inactive { color: #64748b; }
        /* Animation pour mettre en valeur l'√©l√©ment modifi√© */
        @keyframes highlight {
            0% { background-color: #dbeafe; }
            100% { background-color: white; }
        }
        .highlight-item {
            animation: highlight 2s ease-out;
        }
        /* Style pour les onglets du formulaire */
        .form-tab-active { background-color: #2563eb; color: white; }
        .form-tab-inactive { background-color: #f1f5f9; color: #64748b; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "@hebcal/core": "https://esm.sh/@hebcal/core@5.4.0"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Settings, Plus, Trash2, Edit2, Save, X, BookOpen, Heart, ArrowLeft, Loader2, Check, CheckCircle, RefreshCw, LogIn, Download, LogOut, Grid, Repeat, Users, ChevronRight, Undo, Upload, Printer, Calendar, Camera, Image as ImageIcon } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            setDoc,
            writeBatch,
            getDocs
        } from 'firebase/firestore';
        import { HDate, HebrewCalendar, Location } from '@hebcal/core';

        // --- DONN√âES INITIALES ---
        const INITIAL_DATA = [
            // --- Petits-enfants ---
            { name: "Sheina bat Aziza Sara", hebrewDate: "8 Tichri", birthDate: "2025-10-01", gender: "girl" },
            { name: "Zvi Ben Preciada L√©a", hebrewDate: "5 Tamouz", birthDate: "2025-07-01", gender: "boy" },
            { name: "Yeshua Nahman Ben Haya Moushka", hebrewDate: "19 Adar", birthDate: "2025-03-19", gender: "boy" },
            { name: "Israel Ben Dvorah L√©a", hebrewDate: "23 Tichri", birthDate: "2024-10-25", gender: "boy" },
            { name: "Shterna Sara Bat Preciada L√©a", hebrewDate: "10 Av", birthDate: "2024-08-14", gender: "girl" },
            { name: "Orah Aliza Bat Odel Aidel", hebrewDate: "30 Shevat", birthDate: "2024-02-09", gender: "girl" },
            { name: "Haya Moushka Bat Preciada L√©a", hebrewDate: "17 Tamouz", birthDate: "2023-07-06", gender: "girl" },
            { name: "Yossef Ytshak Ben Aziza Sara", hebrewDate: "8 Shevat", birthDate: "2023-01-30", gender: "boy" },
            { name: "Levi Ytshak Ben Haya Mushka", hebrewDate: "11 Sivan", birthDate: "2022-06-10", gender: "boy" },
            { name: "Menahem Mendel Ben Dvorah L√©a", hebrewDate: "22 Kislev", birthDate: "2021-11-26", gender: "boy" },
            { name: "Shmuel Ben Aziza Sara", hebrewDate: "7 Iyar", birthDate: "2020-05-01", gender: "boy" },
            { name: "Shenr.Z Ben Odel Aidel", hebrewDate: "7 Adar", birthDate: "2020-03-03", gender: "boy" },
            { name: "Haya Mushka Bat Dvorah L√©a", hebrewDate: "24 Adar B", birthDate: "2019-03-31", gender: "girl" },
            { name: "Hinda Braha Bat Sima Golda", hebrewDate: "28 Heshvan", birthDate: "2018-11-06", gender: "girl" },
            { name: "Rivka Bat Aziza Sara", hebrewDate: "2 Kislev", birthDate: "2017-11-21", gender: "girl" },
            { name: "Yshai M.M. Ben Rina Haya Mushka", hebrewDate: "29 Ellul", birthDate: "2017-09-20", gender: "boy" },
            { name: "Sheina Preciada Bat Odel Aidel", hebrewDate: "6 Tamouz", birthDate: "2017-06-30", gender: "girl" },
            { name: "Shneior Z. Ben Dvorah L√©a", hebrewDate: "9 Ellul", birthDate: "2016-09-12", gender: "boy" },
            { name: "Tsemah David Zvi Ben Rina Haya Mushka", hebrewDate: "29 Ellul", birthDate: "2015-09-13", gender: "boy" },
            { name: "Dvorah L√©a Bat Aziza Sara", hebrewDate: "29 Sivan", birthDate: "2015-06-16", gender: "girl" },
            { name: "Shmouel Ben Dvorah L√©a", hebrewDate: "2 Adar", birthDate: "2015-02-21", gender: "boy" },
            { name: "Eythan Yehuda Ben Rina Haya Moushka", hebrewDate: "24 Kislev", birthDate: "2014-12-16", gender: "boy" },
            { name: "Haya Mushka Bat Aziza Sara", hebrewDate: "23 Kislev", birthDate: "2012-12-07", gender: "girl" },
            
            // --- Nouveaux Ajouts ---
            { name: "√âlie", hebrewDate: "28 Kislev", birthDate: "2002-12-03", gender: "boy" },
            { name: "Ron Baralviski Ben Tamar Noa", hebrewDate: "10 Kislev", birthDate: "2002-11-15", gender: "boy" },
            { name: "David Aharon", hebrewDate: "26 Cheshvan", birthDate: "2001-11-12", gender: "boy" },
            { name: "Avraham Betsalel", hebrewDate: "14 Tichri", birthDate: "2001-10-01", gender: "boy" },
            { name: "Rephael", hebrewDate: "11 Tichrei", birthDate: "1997-10-12", gender: "boy" },
            { name: "Preciada Lea bat Batsheva", hebrewDate: "25 Nissan 5755", birthDate: "1995-04-25", gender: "girl" },
            { name: "Haya Mouchka bat Batsheva", hebrewDate: "5 Adar 5753", birthDate: "1993-02-26", gender: "girl" },
            { name: "Odele", hebrewDate: "1 Tichri", birthDate: "1993-09-16", gender: "girl" },
            { name: "Levi Duchman", hebrewDate: "20 Sivan 5752", birthDate: "1992-06-21", gender: "boy" },
            { name: "Avraham Ben Batsheva", hebrewDate: "11 Cheshvan 5751", birthDate: "1990-10-30", gender: "boy" },
            { name: "Meir Ben Batsheva", hebrewDate: "17 Adar 5750", birthDate: "1990-03-14", gender: "boy" },
            { name: "Haya M Hassin", hebrewDate: "1 Av", birthDate: "1990-07-23", gender: "girl" },
            { name: "Dvorah L√©a bat Hanna", hebrewDate: "25 Tichri 5750", birthDate: "1989-10-24", gender: "girl" },
            { name: "Rina", hebrewDate: "7 Tevet", birthDate: "1990-01-04", gender: "girl" },
            { name: "Levi Yitschak Ava Ben Batsheva", hebrewDate: "20 Sivan 5749", birthDate: "1989-06-23", gender: "boy" },
            { name: "Aziza Sara bat Batsheva", hebrewDate: "1 Shvat 5748", birthDate: "1988-01-20", gender: "girl" },
            { name: "Hillel Menahem Ben Atara", hebrewDate: "17 Adar 5746", birthDate: "1986-02-26", gender: "boy" }
        ];

        const HEBREW_MONTHS = [
            { id: 1, name: "Nisan", label: "Nissan" },
            { id: 2, name: "Iyyar", label: "Iyar" },
            { id: 3, name: "Sivan", label: "Sivan" },
            { id: 4, name: "Tamuz", label: "Tamouz" },
            { id: 5, name: "Av", label: "Av" },
            { id: 6, name: "Elul", label: "Eloul" },
            { id: 7, name: "Tishrei", label: "Tichri" },
            { id: 8, name: "Cheshvan", label: "Hechvan" },
            { id: 9, name: "Kislev", label: "Kislev" },
            { id: 10, name: "Tevet", label: "Tevet" },
            { id: 11, name: "Shvat", label: "Chevat" },
            { id: 12, name: "Adar", label: "Adar" }, 
            { id: 12, name: "Adar I", label: "Adar I" }, 
            { id: 13, name: "Adar II", label: "Adar II" } 
        ];

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDl6C8AbOgnPkBhqabE3KJGmnJDQ6snXvs",
            authDomain: "mom-s-daily-tehilim.firebaseapp.com",
            projectId: "mom-s-daily-tehilim",
            storageBucket: "mom-s-daily-tehilim.firebasestorage.app",
            messagingSenderId: "440475739791",
            appId: "1:440475739791:web:de509df902068900bb72fa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'moms-tehillim-app'; 

        // --- COMPOSANT PRINCIPAL ---
        function TehillimApp() {
            // State Auth
            const [user, setUser] = useState(null);
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [isExporting, setIsExporting] = useState(false);
            
            // State Donn√©es
            const [children, setChildren] = useState([]);
            const [completedIds, setCompletedIds] = useState([]); 
            const [segulaProgress, setSegulaProgress] = useState({});
            
            // State Navigation & UI
            const [activeTab, setActiveTab] = useState('children');
            const [view, setView] = useState('list');
            const [todayHebrew, setTodayHebrew] = useState("");
            
            // State Lecteur
            const [readerContext, setReaderContext] = useState(null); 
            const [psalmText, setPsalmText] = useState(null);
            const [loadingPsalm, setLoadingPsalm] = useState(false);
            const [scrollToId, setScrollToId] = useState(null);

            // State Formulaire
            const [editingId, setEditingId] = useState(null);
            const [formData, setFormData] = useState({ 
                name: '', 
                hebrewDate: '', 
                birthDate: '', 
                gender: 'girl',
                imageUrl: '' // Pour stocker l'image en base64
            });
            const [dateInputMode, setDateInputMode] = useState('gregorian'); 
            const [hebrewDateParts, setHebrewDateParts] = useState({
                day: 1,
                month: 7, 
                year: 5785
            });
            const fileInputRef = useRef(null);

            // --- INIT ---
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoadingAuth(false);
                });

                const now = new Date();
                const hNow = new HDate(now);
                const monthName = HEBREW_MONTHS.find(m => m.name === hNow.getMonthName())?.label || hNow.getMonthName();
                setTodayHebrew(`${hNow.getDate()} ${monthName} ${hNow.getFullYear()}`);

                return () => unsubscribe();
            }, []);

            // --- LISTENERS ---
            useEffect(() => {
                if (!user) return;

                const childrenRef = collection(db, 'artifacts', appId, 'users', user.uid, 'children');
                const unsubscribeChildren = onSnapshot(childrenRef, (snapshot) => {
                    const kids = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setChildren(kids);
                });

                const todayStr = new Date().toDateString();
                const completedRef = doc(db, 'artifacts', appId, 'users', user.uid, 'completed', todayStr);
                const unsubscribeCompleted = onSnapshot(completedRef, (docSnap) => {
                    if (docSnap.exists()) setCompletedIds(docSnap.data().ids || []);
                    else setCompletedIds([]);
                });

                const segulaRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'segula_progress');
                const unsubscribeSegula = onSnapshot(segulaRef, (docSnap) => {
                    if (docSnap.exists()) setSegulaProgress(docSnap.data());
                    else setSegulaProgress({});
                });

                return () => { unsubscribeChildren(); unsubscribeCompleted(); unsubscribeSegula(); };
            }, [user]);

            useEffect(() => {
                if (view === 'list' && scrollToId) {
                    setTimeout(() => {
                        const element = document.getElementById(scrollToId);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            element.classList.add('highlight-item');
                            setTimeout(() => element.classList.remove('highlight-item'), 2000);
                        }
                        setScrollToId(null);
                    }, 150);
                }
            }, [view, scrollToId]);

            // --- LOGIC ---
            const calculateChapter = (birthDateString) => {
                if (!birthDateString) return 1;
                try {
                    const birthDate = new Date(birthDateString);
                    const birthHDate = new HDate(birthDate);
                    const todayHDate = new HDate();
                    let age = todayHDate.getFullYear() - birthHDate.getFullYear();
                    
                    const monthOrder = { 7:1, 8:2, 9:3, 10:4, 11:5, 12:6, 13:7, 1:8, 2:9, 3:10, 4:11, 5:12, 6:13 };
                    const mBirth = monthOrder[birthHDate.getMonth()];
                    const mToday = monthOrder[todayHDate.getMonth()];
                    
                    if (mToday < mBirth) { age--; } 
                    else if (mToday === mBirth) { if (todayHDate.getDate() < birthHDate.getDate()) { age--; } }
                    return age + 1;
                } catch (e) {
                    const birthDate = new Date(birthDateString);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const m = today.getMonth() - birthDate.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
                    return age + 1;
                }
            };

            const handleGoogleLogin = async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (error) { alert("Erreur: " + error.message); }
            };

            const handleLogout = async () => {
                if (window.confirm("Voulez-vous vraiment vous d√©connecter ?")) {
                    await signOut(auth);
                    setActiveTab('children');
                    setView('list');
                }
            };

            const cleanText = (text, isHebrew = false) => {
                if (!text) return "";
                let cleaned = text.replace(/<[^>]+>/g, '').replace(/&[a-z0-9#]+;/gi, '').replace(/\{[^}]+\}/g, '').replace(/\[[^\]]+\]/g, '').replace(/◊Ä/g, '').trim();
                if (isHebrew) cleaned = cleaned.replace(/[a-zA-Z]/g, '');
                return cleaned;
            };

            // Image Handler
            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) {
                    alert("Image trop grande. Veuillez choisir une image de moins de 5MB.");
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Resize pour ic√¥ne (max 200x200)
                        const MAX_SIZE = 200;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        setFormData(prev => ({ ...prev, imageUrl: dataUrl }));
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            const handleExportPDF = async () => {
                if (children.length === 0) { alert("Aucun enfant dans la liste."); return; }
                if (!window.confirm("G√©n√©rer un PDF avec les Psaumes en h√©breu ?")) return;
                setIsExporting(true);
                try {
                    const uniqueChapters = [...new Set(children.map(c => calculateChapter(c.birthDate)))];
                    const textsCache = {};
                    await Promise.all(uniqueChapters.map(async (chapter) => {
                        try {
                            const res = await fetch(`https://www.sefaria.org/api/texts/Psalms.${chapter}?context=0`);
                            const data = await res.json();
                            textsCache[chapter] = data.he; 
                        } catch (e) { textsCache[chapter] = ["(Erreur de chargement)"]; }
                    }));

                    const printWindow = window.open('', '_blank');
                    if (!printWindow) { alert("Autorisez les pop-ups pour le PDF."); setIsExporting(false); return; }

                    let htmlContent = `<html><head><title>Tehilim</title><style>@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+Hebrew:wght@400;700&display=swap'); body { font-family: 'Noto Serif Hebrew', serif; padding: 40px; direction: rtl; } .child-block { margin-bottom: 40px; break-inside: avoid; border-bottom: 1px dashed #ccc; padding-bottom: 20px; } .header-info { text-align: center; margin-bottom: 15px; } .child-name { font-size: 18px; font-weight: bold; font-family: sans-serif; direction: ltr; display: inline-block; } .hebrew-text { font-size: 24px; line-height: 1.4; text-align: right; }</style></head><body><div style="text-align: center; margin-bottom: 40px;"><h1 style="font-size: 32px;">◊ß◊ï◊†◊ò◊®◊° ◊™◊î◊ô◊ú◊ô◊ù</h1><p>Les Tehilim de Maman - ${new Date().toLocaleDateString('fr-FR')}</p></div>`;
                    const sorted = [...children].sort((a,b) => new Date(b.birthDate) - new Date(a.birthDate));
                    sorted.forEach(child => {
                        const chapter = calculateChapter(child.birthDate);
                        const verses = textsCache[chapter] || [];
                        htmlContent += `<div class="child-block"><div class="header-info"><div class="child-name">${child.name}</div><div>Psaume ${chapter}</div></div><div class="hebrew-text">${verses.map(v => v.replace(/<[^>]+>/g, '')).join(' ')}</div></div>`;
                    });
                    htmlContent += `<script>window.onload = function() { window.print(); }<\/script></body></html>`;
                    printWindow.document.write(htmlContent); printWindow.document.close();
                } catch (e) { alert("Erreur : " + e.message); } finally { setIsExporting(false); }
            };

            const openReader = async (context) => {
                let domId = '';
                if (context.type === 'child') domId = `child-${context.id}`;
                else if (context.type === 'chapter') domId = `chapter-${context.id}`;
                else if (context.type === 'segula') domId = `segula-${context.id}`;
                setScrollToId(domId);
                setReaderContext(context);
                setView('reader');
                setLoadingPsalm(true);
                setPsalmText(null);
                try {
                    const response = await fetch(`https://www.sefaria.org/api/texts/Psalms.${context.chapter}?context=0`);
                    const data = await response.json();
                    setPsalmText(data);
                } catch (error) { console.error("Error", error); alert("Erreur chargement texte"); } finally { setLoadingPsalm(false); }
            };

            const incrementSegula = async (id) => {
                if (!user) return;
                const currentCount = segulaProgress[id] || 0;
                if (currentCount >= 13) return;
                const newCount = currentCount + 1;
                const segulaRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'segula_progress');
                setSegulaProgress(prev => ({...prev, [id]: newCount}));
                await setDoc(segulaRef, { [id]: newCount }, { merge: true });
            };

            const resetSegula = async (id) => {
                if (!window.confirm("Remettre √† z√©ro ?")) return;
                const segulaRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'segula_progress');
                setSegulaProgress(prev => ({...prev, [id]: 0}));
                await setDoc(segulaRef, { [id]: 0 }, { merge: true });
            };

            const markChildAsDone = async (childId) => {
                if (!user) return;
                const todayStr = new Date().toDateString();
                const completedRef = doc(db, 'artifacts', appId, 'users', user.uid, 'completed', todayStr);
                const newIds = [...completedIds, childId];
                setCompletedIds(newIds);
                await setDoc(completedRef, { ids: newIds, date: todayStr }, { merge: true });
            };

            const unmarkChildAsDone = async (childId) => {
                if (!user) return;
                if (!window.confirm("Annuler la lecture ?")) return;
                const todayStr = new Date().toDateString();
                const completedRef = doc(db, 'artifacts', appId, 'users', user.uid, 'completed', todayStr);
                const newIds = completedIds.filter(id => id !== childId);
                setCompletedIds(newIds);
                await setDoc(completedRef, { ids: newIds, date: todayStr }, { merge: true });
            };

            const handleDownloadBackup = () => {
                const jsonString = JSON.stringify(children, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const href = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = href; link.download = `backup_tehillim.json`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const handleRestoreBackup = async (event) => {
                const file = event.target.files[0];
                if (!file || !user) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!Array.isArray(data)) throw new Error("Format invalide");
                        if (!window.confirm(`Restaurer ${data.length} enfants ?`)) return;
                        const batch = writeBatch(db);
                        const childrenRef = collection(db, 'artifacts', appId, 'users', user.uid, 'children');
                        const snapshot = await getDocs(childrenRef);
                        snapshot.forEach(doc => batch.delete(doc.ref));
                        data.forEach(child => { const { id, ...childData } = child; batch.set(doc(childrenRef), childData); });
                        await batch.commit(); alert("Restauration r√©ussie !");
                    } catch (error) { alert("Erreur : " + error.message); }
                };
                reader.readAsText(file);
            };

            const restoreDefaults = async () => {
                if (!user || !window.confirm("Cela va √©craser la liste. Continuer ?")) return;
                const batch = writeBatch(db);
                const childrenRef = collection(db, 'artifacts', appId, 'users', user.uid, 'children');
                try {
                    const snapshot = await getDocs(childrenRef);
                    snapshot.forEach(doc => batch.delete(doc.ref));
                    INITIAL_DATA.forEach(child => batch.set(doc(childrenRef), child));
                    await batch.commit(); alert("Liste restaur√©e !");
                } catch (e) { alert("Erreur : " + e.message); }
            };

            const handleSaveChild = async (e) => {
                e.preventDefault();
                if (!user) return;
                let targetId = editingId;
                try {
                    if (editingId) await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'children', editingId), formData);
                    else { const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'children'), formData); targetId = docRef.id; }
                    setEditingId(null); setFormData({ name: '', hebrewDate: '', birthDate: '', gender: 'girl', imageUrl: '' });
                    setView('list'); setScrollToId(`child-${targetId}`);
                } catch (error) { alert("Erreur sauvegarde: " + error.message); }
            };

            const deleteChild = async (id) => {
                if (window.confirm('Supprimer ?')) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'children', id));
            };

            const handleGregorianChange = (e) => {
                const newDate = e.target.value;
                setFormData({ ...formData, birthDate: newDate });
                
                if (newDate) {
                    try {
                        const hDate = new HDate(new Date(newDate));
                        const monthName = HEBREW_MONTHS.find(m => m.name === hDate.getMonthName())?.label || hDate.getMonthName();
                        setFormData(prev => ({
                            ...prev, 
                            birthDate: newDate,
                            hebrewDate: `${hDate.getDate()} ${monthName} ${hDate.getFullYear()}`
                        }));
                        setHebrewDateParts({
                            day: hDate.getDate(),
                            month: hDate.getMonth(), 
                            year: hDate.getFullYear()
                        });
                    } catch (error) { console.error(error); }
                }
            };

            const handleHebrewPartsChange = (field, value) => {
                const newParts = { ...hebrewDateParts, [field]: parseInt(value) };
                setHebrewDateParts(newParts);
                
                try {
                    const hDate = new HDate(newParts.day, newParts.month, newParts.year);
                    const gDate = hDate.greg();
                    const gDateString = gDate.toISOString().split('T')[0];
                    const monthName = HEBREW_MONTHS.find(m => m.id === newParts.month)?.label || hDate.getMonthName();
                    
                    setFormData(prev => ({
                        ...prev,
                        birthDate: gDateString,
                        hebrewDate: `${newParts.day} ${monthName} ${newParts.year}`
                    }));
                } catch (error) { console.error("Invalid Hebrew Date", error); }
            };

            const startEdit = (child) => {
                setFormData(child);
                setEditingId(child.id);
                if (child.birthDate) {
                    const hDate = new HDate(new Date(child.birthDate));
                    setHebrewDateParts({
                        day: hDate.getDate(),
                        month: hDate.getMonth(),
                        year: hDate.getFullYear()
                    });
                }
                setView('settings');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const sortedChildren = [...children].sort((a, b) => new Date(b.birthDate) - new Date(a.birthDate));

            // --- RENDER HELPERS ---
            if (loadingAuth) return <div className="min-h-screen flex items-center justify-center"><Loader2 className="animate-spin text-slate-400" /></div>;
            if (isExporting) return <div className="min-h-screen flex items-center justify-center bg-black/80 fixed inset-0 z-[100] text-white flex-col gap-4"><Loader2 className="animate-spin" size={48} /><div className="text-center"><p className="text-xl font-bold">Pr√©paration du document...</p></div></div>;
            if (!user) return <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4"><div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 max-w-sm w-full text-center"><h1 className="text-2xl font-bold text-slate-800 font-serif mb-2">◊ê◊ú ◊î◊†◊¢◊® ◊î◊ñ◊î ◊î◊™◊§◊ú◊ú◊™◊ô</h1><p className="text-slate-500 mb-8 uppercase tracking-widest text-xs">Les Tehilim de Maman</p><button onClick={handleGoogleLogin} className="w-full bg-blue-600 text-white px-4 py-3 rounded-xl font-medium flex items-center justify-center gap-2 shadow-sm shadow-blue-200"><LogIn size={20} /> Se connecter avec Google</button></div></div>;

            if (view === 'reader' && readerContext) {
                const isSegula = readerContext.type === 'segula';
                const segulaCount = isSegula ? (segulaProgress[readerContext.id] || 0) : 0;
                const isSegulaDone = segulaCount >= 13;
                return (
                    <div className="min-h-screen bg-white flex flex-col">
                        <header className="bg-white border-b sticky top-0 z-20 px-4 py-3 flex items-center justify-between"><button onClick={() => setView('list')} className="flex items-center gap-1 text-slate-600"><ArrowLeft size={20} /> Retour</button><div className="text-center"><span className="text-xs font-bold text-blue-600 uppercase">Psaume {readerContext.chapter}</span><p className="text-sm font-semibold truncate max-w-[200px]">{readerContext.type === 'child' ? readerContext.data.name : readerContext.type === 'segula' ? `S√©goula #${readerContext.id}` : 'Lecture Libre'}</p></div><div className="w-8"></div></header>
                        <main className="flex-1 p-6 max-w-2xl mx-auto w-full">{loadingPsalm ? <div className="flex justify-center py-20"><Loader2 className="animate-spin text-slate-400" /></div> : psalmText && (<div className="pb-24"><div className="text-right font-serif text-4xl leading-loose text-slate-900 mb-8" dir="rtl">{psalmText.he.map((v, i) => <span key={i}><span className="text-lg text-slate-400 ml-2">({i+1})</span>{cleanText(v, true)} </span>)}</div><div className="h-px bg-slate-100 my-8 mx-10"></div><div className="text-left font-serif text-lg leading-relaxed text-slate-600">{psalmText.text.map((v, i) => <p key={i} className="mb-2"><sup className="text-xs text-slate-400 mr-2">{i+1}</sup>{cleanText(v)}</p>)}</div></div>)}</main>
                        <div className="sticky bottom-0 bg-white border-t p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]"><div className="max-w-md mx-auto">{readerContext.type === 'child' && <button onClick={() => { markChildAsDone(readerContext.id); setView('list'); }} className="w-full bg-green-600 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all"><CheckCircle size={24} /> J'ai termin√©</button>}{readerContext.type === 'segula' && <div className="flex items-center gap-3"><div className="flex-1 text-center"><span className="block text-xs text-slate-500 uppercase tracking-wide">Compteur</span><span className={`text-2xl font-bold ${isSegulaDone ? 'text-green-600' : 'text-blue-600'}`}>{segulaCount} / 13</span></div><button onClick={() => incrementSegula(readerContext.id)} disabled={isSegulaDone} className={`flex-2 px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 ${isSegulaDone ? 'bg-green-100 text-green-700' : 'bg-blue-600 text-white shadow-lg shadow-blue-200'}`}>{isSegulaDone ? <Check size={20} /> : <Repeat size={20} />}{isSegulaDone ? 'Termin√© !' : 'J\'ai lu le Psaume'}</button></div>}</div></div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 pb-20 font-sans flex flex-col">
                    <div className="bg-white shadow-sm sticky top-0 z-10"><div className="bg-slate-50 py-1 px-4 flex justify-between items-center text-[10px] border-b"><p className="text-slate-500 font-serif font-medium">{todayHebrew}</p><div className="flex items-center gap-2"><span className="flex items-center gap-1 text-green-600 font-medium"><span className="w-1.5 h-1.5 rounded-full bg-green-500"></span>{user.email}</span><button onClick={handleLogout} className="text-slate-400 hover:text-red-500 transition-colors p-1"><LogOut size={14} /></button></div></div><div className="px-4 py-3 flex justify-between items-center"><div><h1 className="text-lg font-bold text-slate-800 font-serif">◊ê◊ú ◊î◊†◊¢◊® ◊î◊ñ◊î ◊î◊™◊§◊ú◊ú◊™◊ô</h1><p className="text-[10px] text-slate-500 uppercase tracking-widest">Les Tehilim de Maman</p></div><div className="flex gap-2">{view === 'list' && activeTab === 'children' && <button onClick={handleDownloadBackup} className="p-2 bg-slate-100 rounded-full text-slate-600"><Download size={18} /></button>}<button onClick={() => setView(view === 'settings' ? 'list' : 'settings')} className="p-2 bg-slate-100 rounded-full text-slate-600">{view === 'settings' ? <X size={18} /> : <Settings size={18} />}</button></div></div>{view !== 'settings' && (<div className="flex border-b text-sm font-medium"><button onClick={() => setActiveTab('children')} className={`flex-1 py-3 text-center flex justify-center items-center gap-2 ${activeTab === 'children' ? 'tab-active' : 'tab-inactive'}`}><Users size={16} /> Enfants</button><button onClick={() => setActiveTab('all')} className={`flex-1 py-3 text-center flex justify-center items-center gap-2 ${activeTab === 'all' ? 'tab-active' : 'tab-inactive'}`}><Grid size={16} /> Tout</button><button onClick={() => setActiveTab('segula')} className={`flex-1 py-3 text-center flex justify-center items-center gap-2 ${activeTab === 'segula' ? 'tab-active' : 'tab-inactive'}`}><Repeat size={16} /> 13 x 13</button></div>)}</div>

                    <main className="flex-1 p-4 max-w-md mx-auto w-full">
                        {view === 'settings' ? (
                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-300 space-y-6">
                                <div className="bg-white p-5 rounded-xl border shadow-sm">
                                    <h2 className="font-bold flex items-center gap-2 mb-4 text-slate-800">{editingId ? <Edit2 size={18} /> : <Plus size={18} />} {editingId ? 'Modifier' : 'Ajouter un enfant'}</h2>
                                    <form onSubmit={handleSaveChild} className="space-y-4">
                                        <div className="flex flex-col items-center gap-2 mb-2">
                                            <div className="w-20 h-20 rounded-full bg-slate-100 border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden relative cursor-pointer hover:border-blue-400 transition-colors" onClick={() => fileInputRef.current.click()}>
                                                {formData.imageUrl ? <img src={formData.imageUrl} className="w-full h-full object-cover" /> : <Camera size={24} className="text-slate-400" />}
                                            </div>
                                            <button type="button" onClick={() => fileInputRef.current.click()} className="text-xs text-blue-600 font-medium">Ajouter une photo</button>
                                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageChange} />
                                            {formData.imageUrl && <button type="button" onClick={() => setFormData({...formData, imageUrl: ''})} className="text-xs text-red-500">Supprimer</button>}
                                        </div>

                                        <input required className="w-full p-3 bg-slate-50 border rounded-lg text-sm" placeholder="Nom complet" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                        <select className="w-full p-3 bg-slate-50 border rounded-lg text-sm" value={formData.gender} onChange={e => setFormData({...formData, gender: e.target.value})}><option value="girl">Fille ‚ù§Ô∏è</option><option value="boy">Gar√ßon üíô</option></select>
                                        
                                        <div className="bg-slate-50 rounded-lg p-1 flex text-sm">
                                            <button type="button" onClick={() => setDateInputMode('gregorian')} className={`flex-1 py-2 rounded-md transition-all ${dateInputMode === 'gregorian' ? 'bg-white shadow-sm text-blue-600 font-bold' : 'text-slate-500'}`}>Date Civile</button>
                                            <button type="button" onClick={() => setDateInputMode('hebrew')} className={`flex-1 py-2 rounded-md transition-all ${dateInputMode === 'hebrew' ? 'bg-white shadow-sm text-blue-600 font-bold' : 'text-slate-500'}`}>Date H√©bra√Øque</button>
                                        </div>

                                        {dateInputMode === 'gregorian' ? (
                                            <div className="space-y-2">
                                                <label className="text-xs text-slate-500 font-bold uppercase">Date de naissance</label>
                                                <input required type="date" className="w-full p-3 bg-white border rounded-lg text-sm" value={formData.birthDate} onChange={handleGregorianChange} />
                                                <div className="text-xs text-slate-400 italic">Correspondance h√©bra√Øque : {formData.hebrewDate || '...'}</div>
                                            </div>
                                        ) : (
                                            <div className="space-y-2">
                                                <label className="text-xs text-slate-500 font-bold uppercase">Date H√©bra√Øque</label>
                                                <div className="grid grid-cols-3 gap-2">
                                                    <select className="p-3 bg-white border rounded-lg text-sm" value={hebrewDateParts.day} onChange={e => handleHebrewPartsChange('day', e.target.value)}>
                                                        {Array.from({length: 30}, (_, i) => i + 1).map(d => <option key={d} value={d}>{d}</option>)}
                                                    </select>
                                                    <select className="p-3 bg-white border rounded-lg text-sm" value={hebrewDateParts.month} onChange={e => handleHebrewPartsChange('month', e.target.value)}>
                                                        {HEBREW_MONTHS.map(m => <option key={m.id} value={m.id}>{m.label}</option>)}
                                                    </select>
                                                    <select className="p-3 bg-white border rounded-lg text-sm" value={hebrewDateParts.year} onChange={e => handleHebrewPartsChange('year', e.target.value)}>
                                                        {Array.from({length: 100}, (_, i) => new HDate().getFullYear() - i).map(y => <option key={y} value={y}>{y}</option>)}
                                                    </select>
                                                </div>
                                                <div className="text-xs text-slate-400 italic">Correspondance civile : {formData.birthDate || '...'}</div>
                                            </div>
                                        )}

                                        <div className="flex gap-2 mt-4">
                                            {editingId && <button type="button" onClick={() => {setEditingId(null); setFormData({name:'',hebrewDate:'',birthDate:'',gender:'girl', imageUrl: ''})}} className="flex-1 py-3 border rounded-lg text-slate-600 font-medium">Annuler</button>}
                                            <button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold shadow-md shadow-blue-100 flex items-center justify-center gap-2"><Save size={18} /> {editingId ? 'Mettre √† jour' : 'Enregistrer'}</button>
                                        </div>
                                    </form>
                                </div>
                                <div className="bg-white p-5 rounded-xl border shadow-sm space-y-4">
                                    <h2 className="font-bold text-slate-800 flex items-center gap-2"><Settings size={18} /> Administration</h2>
                                    <div className="grid grid-cols-1 gap-3">
                                        <button onClick={handleExportPDF} className="w-full py-3 bg-slate-800 text-white text-sm font-bold border rounded-xl flex items-center justify-center gap-2 shadow-sm"><Printer size={16} /> G√©n√©rer un PDF (H√©breu)</button>
                                        <div className="h-px bg-slate-100 my-2"></div>
                                        <button type="button" onClick={restoreDefaults} className="w-full py-3 bg-red-50 text-red-600 text-sm font-bold border border-red-100 rounded-xl flex items-center justify-center gap-2"><RefreshCw size={16} /> R√©initialiser avec la nouvelle liste compl√®te</button>
                                        <div className="pt-2"><input type="file" id="backup-upload" className="hidden" accept=".json" onChange={handleRestoreBackup} /><button onClick={() => document.getElementById('backup-upload').click()} className="w-full py-3 bg-slate-100 text-slate-600 text-sm font-bold border rounded-xl flex items-center justify-center gap-2"><Upload size={16} /> Restaurer depuis une sauvegarde</button></div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <>
                                {activeTab === 'children' && (
                                    <div className="space-y-4">
                                        <div className="text-center text-xs font-bold text-green-600 flex items-center justify-center gap-1 mb-2"><CheckCircle size={10} /> {completedIds.length} / {children.length} Termin√©s aujourd'hui</div>
                                        {children.sort((a,b) => new Date(b.birthDate) - new Date(a.birthDate)).map(child => {
                                            const chapter = calculateChapter(child.birthDate);
                                            const isDone = completedIds.includes(child.id);
                                            return (
                                                <div id={`child-${child.id}`} key={child.id} className={`rounded-2xl border overflow-hidden relative p-5 pl-7 transition-all ${isDone ? 'bg-green-50 border-green-200 shadow-none' : 'bg-white border-slate-100 shadow-sm'}`}>
                                                    <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${child.gender === 'boy' ? 'bg-blue-400' : 'bg-pink-400'}`}></div>
                                                    <div className="flex justify-between items-start">
                                                        <div className="flex-1 pr-2">
                                                            <div className="text-xs text-slate-400 mb-1 flex items-center gap-1 uppercase font-semibold tracking-wider">
                                                                {child.imageUrl ? (
                                                                    <div className="w-5 h-5 rounded-full overflow-hidden inline-block align-middle mr-1 border border-slate-200">
                                                                        <img src={child.imageUrl} alt="" className="w-full h-full object-cover" />
                                                                    </div>
                                                                ) : (
                                                                    <Heart size={14} className={`inline align-middle mr-1 ${child.gender === 'boy' ? 'text-blue-500 fill-blue-500' : 'text-pink-500 fill-pink-500'}`} />
                                                                )}
                                                                {child.hebrewDate}
                                                            </div>
                                                            <h2 className={`text-lg font-bold leading-tight ${isDone ? 'text-green-800' : 'text-slate-800'}`}>{child.name}</h2>
                                                        </div>
                                                        <div className={`flex flex-col items-center justify-center p-2 rounded-xl border min-w-[60px] ${isDone ? 'bg-green-100 border-green-200' : 'bg-slate-50 border-slate-100'}`}><span className="text-[10px] text-slate-400">Psaume</span><span className="text-2xl font-bold">{chapter}</span></div>
                                                    </div>
                                                    <div className="flex gap-2 mt-4">
                                                        <div className="flex-1 flex gap-2">
                                                            <button onClick={() => openReader({ type: 'child', id: child.id, chapter, data: child })} className={`flex-1 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${isDone ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-700'}`}>{isDone ? <RefreshCw size={14} /> : <BookOpen size={14} />} {isDone ? 'Relire' : 'Lire'}</button>
                                                            {isDone && <button onClick={() => unmarkChildAsDone(child.id)} className="px-3 bg-red-50 text-red-500 rounded-lg border border-red-100 hover:bg-red-100" title="Annuler (marquer comme non lu)"><Undo size={16} /></button>}
                                                        </div>
                                                        <div className="flex gap-1"><button onClick={() => startEdit(child)} className="p-2 bg-white border rounded-lg text-slate-400 hover:text-blue-600"><Edit2 size={16} /></button><button onClick={() => deleteChild(child.id)} className="p-2 bg-white border rounded-lg text-slate-400 hover:text-red-500"><Trash2 size={16} /></button></div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                                {activeTab === 'all' && (<div className="grid grid-cols-5 gap-2">{Array.from({ length: 150 }, (_, i) => i + 1).map(num => (<button id={`chapter-${num}`} key={num} onClick={() => openReader({ type: 'chapter', id: num, chapter: num })} className="aspect-square bg-white border border-slate-200 rounded-xl flex items-center justify-center font-bold text-slate-700 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-600 transition-colors shadow-sm">{num}</button>))}</div>)}
                                {activeTab === 'segula' && (
                                    <div className="space-y-3">
                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4 text-center"><h3 className="font-bold text-blue-800 text-lg">S√©goula du Psaume 13</h3><p className="text-sm text-blue-600">Dire 13 fois le Psaume 13</p></div>
                                        {[1, 2, 3, 4, 5].map(id => {
                                            const count = segulaProgress[id] || 0;
                                            const isDone = count >= 13;
                                            return (<div id={`segula-${id}`} key={id} className={`bg-white border rounded-xl p-4 flex items-center justify-between shadow-sm ${isDone ? 'border-green-200 bg-green-50' : 'border-slate-100'}`}><div className="flex items-center gap-3"><div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${isDone ? 'bg-green-200 text-green-700' : 'bg-slate-100 text-slate-600'}`}>{isDone ? <Check size={20} /> : `#${id}`}</div><div><h4 className={`font-bold ${isDone ? 'text-green-800' : 'text-slate-800'}`}>S√©goula #{id}</h4><div className="text-xs font-medium text-slate-500 mt-1">Progression : <span className={isDone ? 'text-green-600' : 'text-blue-600'}>{count} / 13</span></div></div></div><div className="flex items-center gap-2"><button onClick={() => openReader({ type: 'segula', id: id, chapter: 13 })} className={`px-4 py-2 rounded-lg text-sm font-bold ${isDone ? 'bg-white text-green-700 border border-green-200' : 'bg-blue-600 text-white shadow-md shadow-blue-100'}`}>{isDone ? 'Voir' : 'Commencer'}</button>{count > 0 && !isDone && (<button onClick={() => resetSegula(id)} className="p-2 text-slate-300 hover:text-red-400" title="R√©initialiser"><RefreshCw size={16} /></button>)}</div></div>);
                                        })}
                                    </div>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<TehillimApp />);
    </script>
</body>
</html>
