import React, { useState, useEffect } from 'react';
import { Settings, Plus, Trash2, Edit2, Save, X, BookOpen, Heart, ArrowLeft, Loader2, Check, CheckCircle, RefreshCw, LogIn, Download } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signInAnonymously, 
  signInWithCustomToken, 
  GoogleAuthProvider, 
  signInWithPopup,
  signOut
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  onSnapshot, 
  query, 
  setDoc,
  writeBatch
} from 'firebase/firestore';

// Donn√©es initiales pour la restauration
const INITIAL_DATA = [
  { name: "Sheina bat Aziza Sara", hebrewDate: "8 Tichri", birthDate: "2025-10-01", gender: "girl" },
  { name: "Zvi Ben Preciada L√©a", hebrewDate: "5 Tamouz", birthDate: "2025-07-01", gender: "boy" },
  { name: "Yeshua Nahman Ben Haya Moushka", hebrewDate: "19 Adar", birthDate: "2025-03-19", gender: "boy" },
  { name: "Israel Ben Dvorah L√©a", hebrewDate: "23 Tichri", birthDate: "2024-10-25", gender: "boy" },
  { name: "Shterna Sara Bat Preciada L√©a", hebrewDate: "10 Av", birthDate: "2024-08-14", gender: "girl" },
  { name: "Orah Aliza Bat Odel Aidel", hebrewDate: "30 Shevat", birthDate: "2024-02-09", gender: "girl" },
  { name: "Haya Moushka Bat Preciada L√©a", hebrewDate: "17 Tamouz", birthDate: "2023-07-06", gender: "girl" },
  { name: "Yossef Ytshak Ben Aziza Sara", hebrewDate: "8 Shevat", birthDate: "2023-01-30", gender: "boy" },
  { name: "Levi Ytshak Ben Haya Mushka", hebrewDate: "11 Sivan", birthDate: "2022-06-10", gender: "boy" },
  { name: "Menahem Mendel Ben Dvorah L√©a", hebrewDate: "22 Kislev", birthDate: "2021-11-26", gender: "boy" },
  { name: "Shmuel Ben Aziza Sara", hebrewDate: "7 Iyar", birthDate: "2020-05-01", gender: "boy" },
  { name: "Shenr.Z Ben Odel Aidel", hebrewDate: "7 Adar", birthDate: "2020-03-03", gender: "boy" },
  { name: "Haya Mushka Bat Dvorah L√©a", hebrewDate: "24 Adar B", birthDate: "2019-03-31", gender: "girl" },
  { name: "Hinda Braha Bat Sima Golda", hebrewDate: "28 Heshvan", birthDate: "2018-11-06", gender: "girl" },
  { name: "Rivka Bat Aziza Sara", hebrewDate: "2 Kislev", birthDate: "2017-11-21", gender: "girl" },
  { name: "Yshai M.M. Ben Rina Haya Mushka", hebrewDate: "29 Ellul", birthDate: "2017-09-20", gender: "boy" },
  { name: "Sheina Preciada Bat Odel Aidel", hebrewDate: "6 Tamouz", birthDate: "2017-06-30", gender: "girl" },
  { name: "Shneior Z. Ben Dvorah L√©a", hebrewDate: "9 Ellul", birthDate: "2016-09-12", gender: "boy" },
  { name: "Tsemah David Zvi Ben Rina Haya Mushka", hebrewDate: "29 Ellul", birthDate: "2015-09-13", gender: "boy" },
  { name: "Dvorah L√©a Bat Aziza Sara", hebrewDate: "29 Sivan", birthDate: "2015-06-16", gender: "girl" },
  { name: "Shmouel Ben Dvorah L√©a", hebrewDate: "2 Adar", birthDate: "2015-02-21", gender: "boy" },
  { name: "Eythan Yehuda Ben Rina Haya Moushka", hebrewDate: "24 Kislev", birthDate: "2014-12-16", gender: "boy" },
  { name: "Haya Mushka Bat Aziza Sara", hebrewDate: "23 Kislev", birthDate: "2012-12-07", gender: "girl" }
];

// --- FIREBASE CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyDl6C8AbOgnPkBhqabE3KJGmnJDQ6snXvs",
  authDomain: "mom-s-daily-tehilim.firebaseapp.com",
  projectId: "mom-s-daily-tehilim",
  storageBucket: "mom-s-daily-tehilim.firebasestorage.app",
  messagingSenderId: "440475739791",
  appId: "1:440475739791:web:de509df902068900bb72fa"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

export default function TehillimApp() {
  // --- STATE ---
  const [user, setUser] = useState(null);
  const [children, setChildren] = useState([]);
  const [completedIds, setCompletedIds] = useState([]);
  
  const [view, setView] = useState('list'); // 'list', 'settings', 'reader'
  const [readingChild, setReadingChild] = useState(null);
  const [psalmText, setPsalmText] = useState(null);
  const [loadingPsalm, setLoadingPsalm] = useState(false);
  const [todayHebrew, setTodayHebrew] = useState("");
  
  const [editingId, setEditingId] = useState(null);
  const [formData, setFormData] = useState({
    name: '',
    hebrewDate: '',
    birthDate: '',
    gender: 'girl'
  });

  // --- INITIALIZATION ---

  useEffect(() => {
    // 1. Auth Initialization
    const initAuth = async () => {
      try {
        // Try custom token first (standard Canvas env flow)
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          // No token provided, try anonymous
          await signInAnonymously(auth);
        }
      } catch (error) {
        // Error handling: The custom token might be for a different project (mismatch)
        // since we are using your specific Firebase config.
        console.warn("Custom token auth failed (likely mismatch with custom config), falling back to anonymous:", error);
        
        try {
          // Fallback to anonymous auth for your specific project
          await signInAnonymously(auth);
        } catch (anonError) {
          console.error("Anonymous auth failed. Please ensure 'Anonymous' sign-in provider is enabled in your Firebase Console.", anonError);
        }
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
    });

    // 2. Hebrew Date Calculation
    try {
      const date = new Date();
      // Using Intl API for Hebrew Calendar
      const formatter = new Intl.DateTimeFormat('fr-FR-u-ca-hebrew', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
      setTodayHebrew(formatter.format(date));
    } catch (e) {
      setTodayHebrew("Date non disponible");
    }

    return () => unsubscribe();
  }, []);

  // --- FIRESTORE LISTENERS ---

  useEffect(() => {
    if (!user) return;

    // A. Listen to Children List
    // IMPORTANT: Using user.uid ensures privacy
    const childrenRef = collection(db, 'artifacts', appId, 'users', user.uid, 'children');
    const unsubscribeChildren = onSnapshot(childrenRef, (snapshot) => {
      const kids = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setChildren(kids);
    }, (error) => console.error("Error fetching children:", error));

    // B. Listen to Completed Status
    // We store completion in a doc named 'daily_{dateString}'
    const todayStr = new Date().toDateString(); // e.g. "Mon Jan 01 2024"
    const completedRef = doc(db, 'artifacts', appId, 'users', user.uid, 'completed', todayStr);
    
    const unsubscribeCompleted = onSnapshot(completedRef, (docSnap) => {
      if (docSnap.exists()) {
        setCompletedIds(docSnap.data().ids || []);
      } else {
        setCompletedIds([]); // Reset if new day (doc doesn't exist yet)
      }
    }, (error) => console.error("Error fetching completion:", error));

    return () => {
      unsubscribeChildren();
      unsubscribeCompleted();
    };
  }, [user]);

  // --- ACTIONS ---

  const handleGoogleLogin = async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
      // Auth state listener will handle the rest
    } catch (error) {
      console.error("Login failed", error);
      alert("Erreur de connexion Google: " + error.message);
    }
  };

  const handleLogout = async () => {
    await signOut(auth);
  };

  const calculateChapter = (birthDateString) => {
    const birthDate = new Date(birthDateString);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    return age + 1;
  };

  const cleanText = (text, isHebrew = false) => {
    if (!text) return "";
    let cleaned = text
      .replace(/<[^>]+>/g, '') 
      .replace(/&[a-z0-9#]+;/gi, '') 
      .replace(/\{[^}]+\}/g, '') 
      .replace(/\[[^\]]+\]/g, '') 
      .replace(/◊Ä/g, '') 
      .trim();
    if (isHebrew) {
      cleaned = cleaned.replace(/[a-zA-Z]/g, '');
    }
    return cleaned;
  };

  const markAsDone = async (childId) => {
    if (!user) return;
    if (completedIds.includes(childId)) return;

    const todayStr = new Date().toDateString();
    const completedRef = doc(db, 'artifacts', appId, 'users', user.uid, 'completed', todayStr);
    
    // Optimistic update
    const newIds = [...completedIds, childId];
    setCompletedIds(newIds);

    try {
      await setDoc(completedRef, { ids: newIds, date: todayStr }, { merge: true });
    } catch (e) {
      console.error("Error saving completion", e);
    }
  };

  // --- BACKUP FUNCTION ---
  const handleDownloadBackup = () => {
    if (children.length === 0) {
      alert("La liste est vide, rien √† sauvegarder.");
      return;
    }
    const jsonString = JSON.stringify(children, null, 2);
    const blob = new Blob([jsonString], { type: "application/json" });
    const href = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = href;
    link.download = `tehillim_backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(href);
  };

  const restoreDefaults = async () => {
    if (!user) return;
    if (!window.confirm("Cela va ajouter toute la liste par d√©faut. Continuer ?")) return;

    const batch = writeBatch(db);
    const childrenRef = collection(db, 'artifacts', appId, 'users', user.uid, 'children');

    INITIAL_DATA.forEach(child => {
      const newDocRef = doc(childrenRef); // Auto ID
      batch.set(newDocRef, child);
    });

    await batch.commit();
    alert("Liste restaur√©e !");
  };

  const handleSave = async (e) => {
    e.preventDefault();
    if (!user) return;

    try {
      if (editingId) {
        // Update
        const childRef = doc(db, 'artifacts', appId, 'users', user.uid, 'children', editingId);
        await updateDoc(childRef, formData);
        setEditingId(null);
      } else {
        // Add
        const childrenRef = collection(db, 'artifacts', appId, 'users', user.uid, 'children');
        await addDoc(childrenRef, formData);
      }
      setFormData({ name: '', hebrewDate: '', birthDate: '', gender: 'girl' });
    } catch (error) {
      console.error("Error saving child:", error);
    }
  };

  const deleteChild = async (id) => {
    if (!user) return;
    if (window.confirm('Voulez-vous vraiment supprimer cet enfant de la liste ?')) {
      try {
        const childRef = doc(db, 'artifacts', appId, 'users', user.uid, 'children', id);
        await deleteDoc(childRef);
      } catch (e) {
        console.error("Error deleting", e);
      }
    }
  };

  const openReader = async (child) => {
    setReadingChild(child);
    setView('reader');
    setLoadingPsalm(true);
    setPsalmText(null);
    const chapter = calculateChapter(child.birthDate);
    try {
      const response = await fetch(`https://www.sefaria.org/api/texts/Psalms.${chapter}?context=0`);
      const data = await response.json();
      setPsalmText(data);
    } catch (error) {
      console.error("Error fetching Psalm", error);
    } finally {
      setLoadingPsalm(false);
    }
  };

  const closeReader = (markDone = false) => {
    if (markDone && readingChild) {
      markAsDone(readingChild.id);
    }
    setView('list');
    setReadingChild(null);
    setPsalmText(null);
  };

  const startEdit = (child) => {
    setFormData(child);
    setEditingId(child.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const sortedChildren = [...children].sort((a, b) => 
    new Date(b.birthDate) - new Date(a.birthDate)
  );

  // --- VIEWS ---

  if (view === 'reader' && readingChild) {
    const chapter = calculateChapter(readingChild.birthDate);
    const isBoy = readingChild.gender === 'boy';
    const accentColor = isBoy ? 'text-blue-600' : 'text-pink-600';
    const bgAccent = isBoy ? 'bg-blue-50' : 'bg-pink-50';

    return (
      <div className="min-h-screen bg-white flex flex-col">
        <header className="bg-white border-b border-slate-100 sticky top-0 z-20 px-4 py-3 flex items-center justify-between shadow-sm">
          <button onClick={() => closeReader(false)} className="flex items-center gap-1 text-slate-600 font-medium">
            <ArrowLeft size={20} />
            Retour
          </button>
          <div className="text-center">
            <span className={`text-xs font-bold uppercase tracking-wider ${accentColor}`}>
              Psaume {chapter}
            </span>
            <p className="text-sm font-semibold text-slate-800 truncate max-w-[150px]">
              {readingChild.name}
            </p>
          </div>
          <div className="w-8"></div>
        </header>

        <main className="flex-1 p-6 max-w-2xl mx-auto w-full">
          {loadingPsalm ? (
            <div className="flex flex-col items-center justify-center h-64 gap-3 text-slate-400">
              <Loader2 className="animate-spin" size={32} />
              <p>Chargement du Psaume...</p>
            </div>
          ) : psalmText ? (
            <div className="animate-in fade-in slide-in-from-bottom-2 duration-500 pb-12">
              <div className="text-right font-serif text-2xl leading-loose text-slate-900 mb-8" dir="rtl">
                {psalmText.he.map((verse, index) => (
                  <span key={index}>
                    <span className="text-xs text-slate-400 align-top ml-1 select-none">
                      ({index + 1})
                    </span>
                    {cleanText(verse, true)}{" "}
                  </span>
                ))}
              </div>

              <div className="h-px bg-slate-100 my-8 mx-10"></div>

              <div className="text-left font-serif text-lg leading-relaxed text-slate-600">
                {psalmText.text.map((verse, index) => (
                   <p key={index} className="mb-2">
                     <sup className="text-xs text-slate-400 mr-2">{index + 1}</sup>
                     {cleanText(verse, false)}
                   </p>
                ))}
              </div>
              
              <div className="mt-12 sticky bottom-6">
                <button 
                  onClick={() => closeReader(true)}
                  className="w-full bg-green-600 text-white shadow-lg shadow-green-200 font-bold text-lg py-4 rounded-xl flex items-center justify-center gap-2 hover:bg-green-700 transition-all active:scale-95"
                >
                  <CheckCircle size={24} />
                  J'ai termin√© la lecture
                </button>
              </div>
            </div>
          ) : (
            <div className="text-center py-10 text-red-400">
              <p>Impossible de charger le texte.</p>
              <p className="text-sm text-slate-500">V√©rifiez votre connexion internet.</p>
            </div>
          )}
        </main>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 pb-20 font-sans">
      <header className="bg-white shadow-sm sticky top-0 z-10 border-b border-slate-200">
        <div className="bg-slate-50 py-1 text-center border-b border-slate-100">
          <p className="text-xs text-slate-500 font-medium font-serif">
            {todayHebrew || "Chargement..."}
          </p>
        </div>
        <div className="max-w-md mx-auto px-4 py-4 flex justify-between items-center">
          <div>
            <h1 className="text-xl font-bold text-slate-800 text-center font-serif leading-tight">
              ◊ê◊ú ◊î◊†◊¢◊® ◊î◊ñ◊î ◊î◊™◊§◊ú◊ú◊™◊ô
            </h1>
            <p className="text-xs text-slate-500 text-center uppercase tracking-widest mt-1">
              Les Tehilim de Maman
            </p>
            {/* Progress Counter */}
            {view === 'list' && (
              <p className="text-xs text-green-600 font-medium text-center uppercase tracking-widest mt-1 flex items-center gap-1 justify-center">
                 <CheckCircle size={10} />
                 {completedIds.length} / {sortedChildren.length || 1} Termin√©s
              </p>
            )}
          </div>
          <div className="flex items-center gap-2">
            {view === 'list' && (
              <button 
                onClick={handleDownloadBackup}
                className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors"
                title="Sauvegarder sur le t√©l√©phone"
              >
                <Download size={20} className="text-slate-600" />
              </button>
            )}
            <button 
              onClick={() => setView(view === 'list' ? 'settings' : 'list')}
              className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors"
            >
              {view === 'list' ? <Settings size={20} className="text-slate-600" /> : <X size={20} className="text-slate-600" />}
            </button>
          </div>
        </div>
        {/* Simple Progress Bar */}
        {view === 'list' && sortedChildren.length > 0 && (
           <div className="h-1 bg-slate-100 w-full">
             <div 
               className="h-full bg-green-500 transition-all duration-500 ease-out"
               style={{ width: `${(completedIds.length / sortedChildren.length) * 100}%` }}
             ></div>
           </div>
        )}
      </header>

      <main className="max-w-md mx-auto p-4">
        {view === 'list' ? (
          <div className="space-y-4">
            {sortedChildren.map((child) => {
              const chapter = calculateChapter(child.birthDate);
              const isBoy = child.gender === 'boy';
              const isDone = completedIds.includes(child.id);
              
              return (
                <div 
                  key={child.id} 
                  className={`rounded-2xl shadow-sm border overflow-hidden relative transition-all duration-300 ${
                    isDone ? 'bg-green-50/50 border-green-200' : 'bg-white border-slate-100'
                  }`}
                >
                  {/* Decorative Side Bar */}
                  <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${isBoy ? 'bg-blue-400' : 'bg-pink-400'} ${isDone ? 'opacity-50' : ''}`}></div>
                  
                  <div className="p-5 pl-7">
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <Heart 
                            size={16} 
                            className={`${isBoy ? 'text-blue-500 fill-blue-500' : 'text-pink-500 fill-pink-500'}`} 
                          />
                          <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider">
                            {child.hebrewDate}
                          </span>
                        </div>
                        <h2 className={`text-lg font-bold leading-snug mb-2 flex items-center gap-2 ${isDone ? 'text-green-800' : 'text-slate-800'}`}>
                          {child.name}
                          {isDone && <CheckCircle size={18} className="text-green-500 fill-green-100" />}
                        </h2>
                      </div>
                      
                      {/* Chapter Badge */}
                      <div className={`flex flex-col items-center justify-center rounded-xl p-3 border min-w-[80px] ${isDone ? 'bg-green-100 border-green-200' : 'bg-slate-50 border-slate-100'}`}>
                        <span className={`text-xs font-medium ${isDone ? 'text-green-600' : 'text-slate-400'}`}>Psaume</span>
                        <span className={`text-3xl font-bold ${isDone ? 'text-green-700' : 'text-slate-700'}`}>{chapter}</span>
                      </div>
                    </div>

                    {/* Action Button */}
                    <div className={`mt-4 pt-3 border-t flex justify-end ${isDone ? 'border-green-100' : 'border-slate-50'}`}>
                      <button 
                        onClick={() => openReader(child)}
                        className={`flex items-center gap-2 text-sm font-medium px-4 py-2 rounded-lg transition-colors w-full justify-center ${
                          isDone 
                           ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                           : (isBoy ? 'bg-blue-50 text-blue-700 hover:bg-blue-100' : 'bg-pink-50 text-pink-700 hover:bg-pink-100')
                        }`}
                      >
                        {isDone ? <Check size={16} /> : <BookOpen size={16} />}
                        {isDone ? `Relire Psaume ${chapter}` : `Lire le Psaume ${chapter}`}
                      </button>
                    </div>
                  </div>
                </div>
              );
            })}
            
            {sortedChildren.length === 0 && (
              <div className="text-center py-10 text-slate-400">
                <p>Votre liste est vide.</p>
                <p className="text-sm">Allez dans les param√®tres pour restaurer la liste par d√©faut ou ajouter des enfants.</p>
              </div>
            )}
          </div>
        ) : (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-300">
            {/* Settings View */}
            
            {/* Authentication Section */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 mb-6">
              <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <Settings size={18} />
                Compte et Sauvegarde
              </h2>
              {user && !user.isAnonymous ? (
                 <div className="bg-green-50 border border-green-100 rounded-lg p-4 flex items-center justify-between">
                   <div className="text-sm text-green-800">
                     <p className="font-bold">Connect√© avec Google</p>
                     <p>{user.email}</p>
                   </div>
                   <button onClick={handleLogout} className="text-xs bg-white border border-green-200 px-3 py-1 rounded shadow-sm text-green-700">
                     D√©connexion
                   </button>
                 </div>
              ) : (
                 <div className="text-center">
                   <p className="text-sm text-slate-500 mb-3">Connectez-vous pour sauvegarder vos donn√©es de fa√ßon permanente.</p>
                   <button 
                     onClick={handleGoogleLogin}
                     className="w-full bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg font-medium hover:bg-slate-50 flex items-center justify-center gap-2"
                   >
                     <LogIn size={18} />
                     Se connecter avec Google
                   </button>
                 </div>
              )}
              
              {children.length === 0 && (
                <button 
                  onClick={restoreDefaults}
                  className="w-full mt-4 bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-medium hover:bg-slate-200 flex items-center justify-center gap-2"
                >
                  <RefreshCw size={16} />
                  Restaurer la liste par d√©faut
                </button>
              )}
            </div>

            {/* Add/Edit Form */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 mb-6">
              <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                {editingId ? <Edit2 size={18} /> : <Plus size={18} />}
                {editingId ? 'Modifier' : 'Ajouter un enfant'}
              </h2>
              
              <form onSubmit={handleSave} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">Nom complet</label>
                  <input
                    required
                    type="text"
                    value={formData.name}
                    onChange={e => setFormData({...formData, name: e.target.value})}
                    placeholder="Ex: Sheina bat Aziza Sara"
                    className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                  />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Date H√©bra√Øque</label>
                    <input
                      type="text"
                      value={formData.hebrewDate}
                      onChange={e => setFormData({...formData, hebrewDate: e.target.value})}
                      placeholder="Ex: 8 Tichri"
                      className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Genre</label>
                    <select
                      value={formData.gender}
                      onChange={e => setFormData({...formData, gender: e.target.value})}
                      className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                    >
                      <option value="girl">Fille (‚ù§Ô∏è)</option>
                      <option value="boy">Gar√ßon (üíô)</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">
                    Date de naissance (pour le calcul)
                  </label>
                  <input
                    required
                    type="date"
                    value={formData.birthDate}
                    onChange={e => setFormData({...formData, birthDate: e.target.value})}
                    className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                  />
                  <p className="text-xs text-slate-400 mt-1">Utilis√©e pour calculer l'√¢ge automatiquement.</p>
                </div>

                <div className="flex gap-2 pt-2">
                  {editingId && (
                    <button
                      type="button"
                      onClick={() => {
                        setEditingId(null);
                        setFormData({ name: '', hebrewDate: '', birthDate: '', gender: 'girl' });
                      }}
                      className="px-4 py-3 rounded-lg border border-slate-200 text-slate-600 font-medium flex-1"
                    >
                      Annuler
                    </button>
                  )}
                  <button
                    type="submit"
                    className="bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 flex-1 flex items-center justify-center gap-2"
                  >
                    <Save size={18} />
                    {editingId ? 'Mettre √† jour' : 'Enregistrer'}
                  </button>
                </div>
              </form>
            </div>

            <div className="space-y-3">
              <h3 className="font-semibold text-slate-500 text-sm uppercase tracking-wider mb-2">G√©rer la liste ({sortedChildren.length})</h3>
              {sortedChildren.map((child) => (
                <div key={child.id} className="flex items-center justify-between p-3 bg-white border border-slate-100 rounded-lg">
                  <div className="flex items-center gap-3 overflow-hidden">
                    <div className={`w-2 h-8 rounded-full ${child.gender === 'boy' ? 'bg-blue-400' : 'bg-pink-400'}`}></div>
                    <div className="truncate">
                      <p className="font-medium text-slate-800 truncate">{child.name}</p>
                      <p className="text-xs text-slate-500">{new Date(child.birthDate).toLocaleDateString('fr-FR')}</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-1">
                    <button 
                      onClick={() => startEdit(child)}
                      className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors"
                    >
                      <Edit2 size={18} />
                    </button>
                    <button 
                      onClick={() => deleteChild(child.id)}
                      className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors"
                    >
                      <Trash2 size={18} />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
